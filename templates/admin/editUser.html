<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>编辑用户</title>
    <style>
        .edit-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group .checkbox-container {
            display: flex;
            align-items: center;
        }
        .form-group .checkbox-container input {
            width: auto;
            margin-right: 10px;
        }
        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-save {
            background-color: #4CAF50;
            color: white;
        }
        .btn-cancel {
            background-color: #f44336;
            color: white;
        }
    </style>
    <link rel="stylesheet" href="/static/css/admin/index.css">
</head>
<body>
<header class="header">
        <div class="logo">
            <img src="/static/images/头像.png" style="border-radius: 50%;" alt="系统Logo">
            <span>久别</span>
        </div>
        <div class="user-info">
            <button class="logout-btn" onclick="window.location.href='/';">退出</button>
        </div>
    </header>


    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 左侧菜单 -->
        <aside class="sidebar">

            <ul>
                <li>
                    <a href="/AdminMain/">
                        <span>用户管理</span>
                    </a>
                </li>
                <li>
                    <a href="/test/" class="active">
                        <span>角色管理</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <span>系统设置</span>
                    </a>
                </li>
            </ul>
        </aside>



<div class="edit-container">
    <h2>编辑用户信息</h2>
    <form id="userEditForm">
        <input type="hidden" id="userId" name="userId">

        <div class="form-group">
            <label for="username">用户名</label>
            <input type="text" id="username" name="username" required>
        </div>

        <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" name="password" placeholder="留空则不修改密码">
        </div>

        <div class="form-group">
            <label for="blacklistStatus">黑名单状态</label>
            <select id="blacklistStatus" name="blacklistStatus">
                <option value="false">正常</option>
                <option value="true">黑名单</option>
            </select>
        </div>

        <div class="btn-container">
            <button type="button" class="btn btn-save" onclick="saveUser()">保存</button>
            <button type="button" class="btn btn-cancel" onclick="cancelEdit()">取消</button>
        </div>
    </form>
    </div>
</div>

<script>
// 页面加载时获取用户详情
document.addEventListener('DOMContentLoaded', () => {
    // 从URL获取用户ID
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');

    if (userId) {
        fetchUserDetails(userId);
    }
});

// 获取用户详情
async function fetchUserDetails(userId) {
    try {
        const response = await fetch(`/Admin/userDetail/${userId}/`);
        const userData = await response.json();

        // 填充表单
        document.getElementById('userId').value = userData.id;
        document.getElementById('username').value = userData.username;
        document.getElementById('blacklistStatus').value = userData.is_blacklisted.toString();
    } catch (error) {
        console.error('获取用户详情失败:', error);
        alert('获取用户详情失败');
    }
}

// 保存用户信息
async function saveUser() {
    const form = document.getElementById('userEditForm');
    const userId = form.userId.value;
    const username = form.username.value;
    const password = form.password.value;
    const blacklistStatus = form.blacklistStatus.value === 'true';

    // 构建提交数据
    const userData = {
        username: username,
        is_blacklisted: blacklistStatus
    };

    // 如果密码非空，则添加到提交数据
    if (password.trim() !== '') {
        userData.password = password;
    }

    try {
        const response = await fetch(`/Admin/editUser/${userId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')  // 假设有获取CSRF token的函数
            },
            body: JSON.stringify(userData)
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert('用户信息更新成功');
            // 跳转回用户列表页
            window.location.href = '/Admin/userList/';
        } else {
            alert('更新失败：' + result.message);
        }
    } catch (error) {
        console.error('保存用户信息失败:', error);
        alert('保存用户信息失败');
    }
}

// 取消编辑
function cancelEdit() {
    window.location.href = '/Admin/userList/';
}

// 获取CSRF Token的函数（Django必需）
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
</body>
</html>